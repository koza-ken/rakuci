Table users {
  id bigint [pk, increment]
  display_name varchar(20) [note: "マイページで表示されるだけの名前"]
  email varchar [unique, not null, note: "ログイン用アドレス"]
  encrypted_password varchar [not null, note: "暗号化済みのパスワード"]
  reset_password_token varchar [note: "パスワードリセット時のトークン"]
  reset_password_sent_at timestamp [note: "リセットメール送信日時"]
  remember_created_at timestamp [note: "ログインを保持する期限"]
  provider varchar(64) [note: "外部認証サービスの識別"]
  uid varchar [note: "外部サービスのユーザー固有ID"]
  created_at timestamp [not null]
  updated_at timestamp [not null]

  Indexes {
    email [unique, name: "index_users_on_email"]
    reset_password_token [unique, name: "index_users_on_reset_password_token"]
    (provider, uid) [unique, name: "index_users_on_provider_and_uid"]
  }

  Note: '''
  Deviseで管理される登録ユーザーのみ。
  ゲストはgroup_membershipsで管理。
  '''
}

Table groups {
  id bigint [pk, increment]
  created_by_user_id int [not null, ref: > users.id, note: "グループ作成者"]
  name varchar(30) [not null]
  invite_token varchar(64) [not null, unique, note: "招待リンク用トークン"]
  created_at timestamp [not null]
  updated_at timestamp [not null]

  Indexes {
    invite_token [unique, name: "index_groups_on_invite_token"]
    created_by_user_id [name: "index_groups_on_created_by_user_id"]
  }

  Note: '''
  招待URLで共有するためのグループ。
  作成にはユーザー登録が必須。
  グループの旅行計画（しおり）は Schedule テーブルで管理される。
  '''

}

Table group_memberships {
  id bigint [pk, increment]
  user_id bigint [null, ref: > users.id, note: "登録ユーザーのみ値あり"]
  group_id bigint [not null, ref: > groups.id, note: "所属グループ"]
  group_nickname varchar(20) [note: "グループ内での表示名"]
  role varchar [not null, default: "member", note: "member or owner"]
  guest_token varchar(64) [note: "ゲスト認証用トークン（user_id=nullの場合のみ）"]
  created_at timestamp [not null]
  updated_at timestamp [not null]

  Indexes {
    (user_id, group_id) [unique, name: "index_group_memberships_on_user_id_and_group_id"]
    (group_id, group_nickname) [unique, name: "index_group_memberships_on_group_id_and_group_nickname"]
    guest_token [name: "index_group_memberships_on_guest_token"]
    user_id [name: "index_group_memberships_on_user_id"]
    group_id [name: "index_group_memberships_on_group_id"]
  }

  Note: '''
  登録ユーザーとゲストの両方を管理。
  - 登録ユーザー: user_id あり、guest_token なし
  - ゲストユーザー: user_id なし、guest_token あり
  '''

}

Table cards {
  id bigint [pk, increment]
  name varchar(50) [not null]
  memo text
  cardable_type varchar [not null, note: "'User' or 'Group'"]
  cardable_id bigint [not null, note: "user_id or group_id（ポリモーフィック）"]
  created_at timestamp [not null]
  updated_at timestamp [not null]

  Indexes {
    (cardable_type, cardable_id) [name: "index_cards_on_cardable_type_and_cardable_id"]
  }

  Note: '''
  個人用・グループ用カード（ポリモーフィック関連付け）
  cardable_type='User' → 個人用カード
  cardable_type='Group' → グループ用カード

  マイグレーション: 20251209050509_add_polymorphic_columns_to_cards.rb で実装

  データ例:
  # 個人用カード
  id=1, name="京都", cardable_type='User', cardable_id=10
  # グループ用カード
  id=2, name="沖縄", cardable_type='Group', cardable_id=5
  '''

}

Table spots {
  id bigint [pk, increment]
  card_id bigint [not null, ref: > cards.id, note: "所属カード"]
  category_id bigint [not null, ref: > categories.id]
  google_place_id varchar [note: "Google Place ID"]
  name varchar(50) [not null, note: "スポット名"]
  address text [note: "住所"]
  phone_number varchar(20) [note: "電話番号"]
  website_url text [note: "公式サイトURL"]
  created_at timestamp [not null]
  updated_at timestamp [not null]

  Indexes {
    card_id [name: "index_spots_on_card_id"]
    category_id [name: "index_spots_on_category_id"]
    (card_id, google_place_id) [unique, name: "index_spots_on_card_id_and_google_place_id", note: "google_place_id IS NOT NULLの場合のみ"]
  }

  Note: '''
  カードに紐づくスポット情報。
  spotsが更新されるとcards.updated_atも更新される（touch: true）。
  '''

}

Table categories {
  id bigint [pk, increment]
  name varchar(20) [not null, note: "カテゴリ名"]
  display_order int [not null, unique, note: "表示順"]
  created_at timestamp [not null]
  updated_at timestamp [not null]

  Indexes {
    display_order [unique, name: "index_categories_on_display_order"]
  }

  Note: '''
  全体共通の固定カテゴリ（シードデータで作成）:
  1. 観光地 (display_order: 1)
  2. グルメ (display_order: 2)
  3. 体験 (display_order: 3)
  4. 買い物 (display_order: 4)

  各カテゴリには対応するSVGアイコンがある。
  Category#icon_partialメソッドでアイコンパスを取得。
  '''

}

Table schedules {
  id bigint [pk, increment]
  schedulable_type varchar [not null, note: "'User' or 'Group'"]
  schedulable_id bigint [not null, note: "user_id or group_id（ポリモーフィック）"]
  name varchar [not null, note: "しおりの名前"]
  start_date date [note: "旅行開始日"]
  end_date date [note: "旅行終了日"]
  memo text [note: "しおり全体のメモ"]
  created_at timestamp [not null]
  updated_at timestamp [not null]

  Indexes {
    (schedulable_type, schedulable_id) [unique, name: "index_schedules_on_polymorphic", note: "WHERE (schedulable_type='Group') → Groupのみユニーク制約"]
  }

  Note: '''
  ユーザーとグループの両方がしおり（旅行計画）を持つことができる。
  - User：複数のスケジュール作成可能（ユニーク制約なし）
  - Group：1つのスケジュールのみ（DB制約とバリデーションで制御）

  【注意】name は DBカラムに制限がないが、モデルのバリデーションで max 50文字に制限している。
  DBのユニーク制約は schedulable_type='Group' のレコードのみに適用される。
  '''
}

Table schedule_spots {
  id bigint [pk, increment]
  schedule_id bigint [not null, ref: > schedules.id, note: "しおりID"]
  spot_id bigint [null, ref: > spots.id, note: "スポットID（カスタム入力時はNULL）"]
  global_position int [not null, note: "全体での順番（acts_as_listで管理）"]
  day_number int [not null, note: "何日目（1日目,2日目...区切り線表示用）"]
  start_time time [note: "開始時刻（到着時刻）"]
  end_time time [note: "終了時刻（出発時刻）"]
  is_custom_entry boolean [not null, default: false, note: "true: カスタム入力, false: Spotからの参照"]
  snapshot_name varchar [note: "スポット名のスナップショット"]
  snapshot_category_id int [note: "カテゴリIDのスナップショット（外部キー制約なし）"]
  snapshot_address varchar [note: "住所のスナップショット"]
  snapshot_phone_number varchar [note: "電話番号のスナップショット"]
  snapshot_website_url varchar [note: "WebサイトURLのスナップショット"]
  google_place_id varchar [note: "Google Place IDのスナップショット"]
  memo text [note: "メモ"]
  created_at timestamp [not null]
  updated_at timestamp [not null]

  Indexes {
    (schedule_id, day_number) [name: "index_ss_on_schedule_and_day"]
    schedule_id [name: "index_schedule_spots_on_schedule_id"]
    spot_id [name: "index_schedule_spots_on_spot_id"]
  }

  Note: '''
  個人用・グループ用のスケジュール（しおり）に追加されたスポット。
  スケジュール作成時点の情報をスナップショットとして保存することで、
  後からスポット情報が変更・削除されても、当時のスケジュール情報は保持される。

  acts_as_listでglobal_positionを管理（スコープ: schedule_id）。
  並び替え機能で順序変更可能。

  is_custom_entry:
  - true  → spot_id IS NULL, snapshot_nameが直接入力される
  - false → spot_id IS NOT NULL, spotsから情報をスナップショットとして保存
  '''

}

Table comments {
  id bigint [pk, increment]
  card_id bigint [not null, ref: > cards.id, note: "コメント対象のカード"]
  group_membership_id bigint [not null, ref: > group_memberships.id, note: "コメント投稿者"]
  content text [not null, note: "コメント内容"]
  created_at timestamp [not null]
  updated_at timestamp [not null]

  Indexes {
    card_id [name: "index_comments_on_card_id"]
    group_membership_id [name: "index_comments_on_group_membership_id"]
    (card_id, created_at) [name: "index_comments_on_card_id_and_created_at"]
  }

  Note: '''
  グループカードのみコメント機能あり。
  CommentsController#check_group_card_accessで権限チェック。
  '''

}

Table item_lists {
  id bigint [pk, increment]
  listable_type varchar [not null, note: "'User' or 'Schedule'"]
  listable_id integer [not null, note: "user_id or schedule_id（ポリモーフィック）"]
  name varchar(100) [note: "リスト名"]
  created_at timestamp [not null]
  updated_at timestamp [not null]

  Indexes {
    (listable_type, listable_id) [unique, name: "index_item_lists_on_listable"]
  }

  Note: '''
  持ち物リスト（ポリモーフィック）
  - User has_one :item_list (listable_type='User') ... ユーザーの永続的なマスターリスト
  - Schedule has_one :item_list (listable_type='Schedule') ... しおりごとの持ち物リスト

  リストの種類の判別:
  - マスターリスト: listable_type == 'User'
  - 個人しおり: listable_type == 'Schedule' && schedule.schedulable_type == 'User'
  - グループしおり: listable_type == 'Schedule' && schedule.schedulable_type == 'Group'

  マスターリストからしおり用リストへのコピーが可能。

  【注意】listable_id は integer（int）で定義。他のほとんどのテーブルは bigint を使用。
  '''
}

Table items {
  id bigint [pk, increment]
  item_list_id integer [not null, ref: > item_lists.id, note: "所属リスト"]
  name varchar(100) [not null, note: "持ち物名"]
  checked boolean [not null, default: false, note: "準備済みか"]
  position integer [note: "並び順（acts_as_listで管理）"]
  created_at timestamp [not null]
  updated_at timestamp [not null]

  Indexes {
    item_list_id [name: "index_items_on_item_list_id"]
    (item_list_id, position) [name: "index_items_on_list_and_position"]
  }

  Note: '''
  個別の持ち物アイテム。
  - acts_as_listでpositionを管理（スコープ: item_list_id）
  - checked: 準備完了フラグ（Ajax更新）

  【注意】item_list_id は integer（int）で定義。他のほとんどのテーブルは bigint を使用。
  '''
}

Table likes {
  id bigint [pk, increment]
  card_id bigint [not null, ref: > cards.id, note: "いいねされたカード"]
  group_membership_id bigint [not null, ref: > group_memberships.id, note: "いいねした人"]
  created_at timestamp [not null]
  updated_at timestamp [not null]

  Indexes {
    (card_id, group_membership_id) [unique, name: "index_likes_on_card_id_and_group_membership_id"]
    card_id [name: "index_likes_on_card_id"]
    group_membership_id [name: "index_likes_on_group_membership_id"]
  }

  Note: '''
  グループカードのみいいね機能あり。
  1人は同じカードに1回のみいいね可能（unique制約）。
  LikesController#check_group_card_accessで権限チェック。
  '''
}

Table expenses {
  id bigint [pk, increment]
  group_id bigint [not null, ref: > groups.id]
  paid_by_membership_id bigint [not null, ref: > group_memberships.id, note: "立て替えた人"]
  name varchar(100) [not null, note: "項目名（ホテル代、交通費等）"]
  amount int [not null, note: "支払額（円、整数で保存）"]
  memo text [note: "支出に関する自由記述メモ"]
  paid_at date [not null, note: "支払日"]
  created_at timestamp [not null]
  updated_at timestamp [not null]

  Indexes {
    group_id [name: "index_expenses_on_group_id"]
    paid_by_membership_id [name: "index_expenses_on_paid_by_membership_id"]
  }

  Note: '''
  グループの支出を記録。
  金額は正の整数のみで保存される。割り勘計算時の端数処理はアプリケーション層で実施。
  メモフィールドで支出の詳細や理由を記録可能。
  SettlementCalculator で支出から精算額を計算。
  '''
}

Table expense_participants {
  id bigint [pk, increment]
  expense_id bigint [not null, ref: > expenses.id]
  group_membership_id bigint [not null, ref: > group_memberships.id, note: "この支出の参加者"]
  created_at timestamp [not null]
  updated_at timestamp [not null]

  Indexes {
    (expense_id, group_membership_id) [unique, name: "index_expense_participants_unique"]
    expense_id [name: "index_expense_participants_on_expense_id"]
    group_membership_id [name: "index_expense_participants_on_membership_id"]
  }

  Note: '''
  支出の参加者を記録。
  各支出に対して、誰が負担するかを管理。
  支出金額を参加者数で均等割りして各自の負担額を計算する。
  デフォルトは全メンバーが参加、必要に応じて除外可能。
  '''
}
