<% content_for(:title, t('expenses.page_title')) %>
<% breadcrumb :group_expenses, @group %>

<main id="main" class="flex flex-col items-center justify-center px-8 py-6 mb-12">
  <div class="w-full max-w-2xl">
    <%# ページタイトル %>
    <h1 class="text-xl font-bold text-text mb-4"><%= t('expenses.page_title') %></h1>

    <%# 支払いを追加する %>
    <div class="mb-8 p-4">
      <%= form_with model: [@group, @expense], local: true, data: { turbo: false }, class: "space-y-4" do |f| %>
        <%# 支払った人 %>
        <div>
          <div class="flex items-center justify-start gap-2 mb-2">
            <%= f.label :paid_by_membership_id, t('expenses.paid_by'), class: "text-sm font-semibold text-text" %>
            <% if @expense.errors[:paid_by_membership].any? %>
              <p class="text-red-600 text-xs">※<%= @expense.errors.full_messages_for(:paid_by_membership).first %></p>
            <% end %>
          </div>
          <%= f.collection_select :paid_by_membership_id,
              @group.group_memberships,
              :id,
              :nickname,
              { prompt: t('expenses.select_payer') },
              { class: "form-text-field w-full" } %>
        </div>

        <%# 対象者チェックボックス %>
        <div>
          <div class="flex items-center justify-start gap-2 mb-2">
            <p class="text-sm font-semibold text-text"><%= t('expenses.participants') %></p>
            <% if @expense.errors[:base].any? %>
              <p class="text-red-600 text-xs">※<%= @expense.errors[:base].first %></p>
            <% end %>
          </div>
          <div class="space-y-2">
            <% @group.group_memberships.each do |membership| %>
              <label class="flex items-center gap-2">
                <%= check_box_tag "expense[participant_ids][]", membership.id, true, { class: "form-checkbox" } %>
                <span class="text-text"><%= membership.nickname %></span>
              </label>
            <% end %>
          </div>
        </div>

        <%# 説明 %>
        <div>
          <div class="flex items-center justify-start gap-2 mb-2">
            <%= f.label :name, t('expenses.description'), class: "text-sm font-semibold text-text" %>
            <% if @expense.errors[:name].any? %>
              <p class="text-red-600 text-xs">※<%= @expense.errors.full_messages_for(:name).first %></p>
            <% end %>
          </div>
          <%= f.text_field :name, placeholder: t('expenses.name_placeholder'), class: "form-text-field w-full" %>
        </div>

        <%# 金額 %>
        <div>
          <div class="flex items-center justify-start gap-2 mb-2">
            <%= f.label :amount, t('expenses.amount'), class: "text-sm font-semibold text-text" %>
            <% if @expense.errors[:amount].any? %>
              <p class="text-red-600 text-xs">※<%= @expense.errors.full_messages_for(:amount).first %></p>
            <% end %>
          </div>
          <div class="flex items-center gap-2">
            <%= f.number_field :amount, placeholder: "0", min: "1", class: "form-text-field flex-1 [&::-webkit-outer-spin-button]:hidden [&::-webkit-inner-spin-button]:hidden" %>
            <span class="text-text">円</span>
          </div>
        </div>

        <%# 支払日 %>
        <div>
          <div class="flex items-center justify-start gap-2 mb-2">
            <%= f.label :paid_at, t('expenses.paid_at'), class: "text-sm font-semibold text-text" %>
            <% if @expense.errors[:paid_at].any? %>
              <p class="text-red-600 text-xs">※<%= @expense.errors.full_messages_for(:paid_at).first %></p>
            <% end %>
          </div>
          <%= f.date_field :paid_at, value: @expense.paid_at || Date.current, class: "form-text-field w-full" %>
        </div>

        <%# 送信ボタン %>
        <div class="flex gap-2 mt-6">
          <%= f.submit t('expenses.add_button'), class: "btn-main flex-1" %>
        </div>
      <% end %>
    </div>

    <%# 支出一覧 %>
    <div class="mb-8">
      <h2 class="text-lg font-bold text-text mb-4"><%= t('expenses.history') %></h2>
      <% if @expenses.any? %>
        <div class="space-y-2">
          <% @expenses.each do |expense| %>
            <div class="p-4 bg-white rounded border border-gray-200">
              <div class="flex items-center justify-between mb-2 gap-2">
                <p class="font-semibold text-text"><%= expense.name %></p>
                <p class="text-text"><%= number_to_currency(expense.amount, unit: '¥', format: '%u%n') %></p>
              </div>
              <div class="flex text-sm text-text-light mb-1">
                <span class="shrink-0"><%= t('expenses.paid_by') %>：</span>
                <span class="flex-1"><%= expense.paid_by_membership.nickname %></span>
              </div>
              <div class="flex text-sm text-text-light mb-1">
                <span class="shrink-0"><%= t('expenses.participants') %>：</span>
                <span class="flex-1"><%= expense.participants.map(&:nickname).join(', ') %></span>
              </div>
              <p class="text-sm text-text-light"><%= l(expense.paid_at, format: :expense_date) %></p>
            </div>
          <% end %>
        </div>
      <% else %>
        <p class="text-text-light text-center py-4"><%= t('expenses.no_expenses') %></p>
      <% end %>
    </div>

    <%# 参加者ごとの精算額 %>
    <div class="mb-8">
      <div class="flex items-center justify-between gap-2 mb-4">
        <h2 class="text-lg font-bold text-text"><%= t('expenses.settlement_summary') %></h2>
        <p class="text-xs text-text-light"><%= t('expenses.settlement_rounding_note') %></p>
      </div>
      <% if @group.group_memberships.any? %>
        <div class="space-y-2">
          <% @group.group_memberships.each do |membership| %>
            <% settlement = @settlements[membership.id] || { paid: 0, participation: 0, settlement: 0 } %>
            <div class="p-4 bg-white rounded border border-gray-200">
              <div class="flex items-center justify-between mb-2">
                <p class="text-text font-semibold"><%= membership.nickname %></p>
                <p>
                  <% if settlement[:settlement] > 0 %>
                    <span class="text-green-600">+<%= number_to_currency(settlement[:settlement], unit: '¥', format: '%u%n', precision: 1) %></span>
                  <% elsif settlement[:settlement] < 0 %>
                    <span class="text-red-600"><%= number_to_currency(settlement[:settlement], unit: '¥', format: '%u%n', precision: 1) %></span>
                  <% else %>
                    <span class="text-text"><%= number_to_currency(0, unit: '¥', format: '%u%n', precision: 0) %></span>
                  <% end %>
                </p>
              </div>
              <div class="text-sm text-text-light space-y-1">
                <p>支払額：<%= number_to_currency(settlement[:paid], unit: '¥', format: '%u%n', precision: 0) %></p>
                <p>負担額：<%= number_to_currency(settlement[:participation], unit: '¥', format: '%u%n', precision: 1) %></p>
              </div>
            </div>
          <% end %>
        </div>
      <% else %>
        <p class="text-text-light text-center py-8"><%= t('expenses.no_members') %></p>
      <% end %>
    </div>

    <%# しおりページに戻るボタン %>
    <div class="mt-12">
      <%= link_to t('expenses.back_to_schedule'), group_schedule_path(@group), class: "btn-sub block text-center" %>
    </div>
  </div>
</main>
