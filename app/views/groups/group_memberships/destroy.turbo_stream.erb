<%# フラッシュメッセージを表示 %>
<%= turbo_stream.update "flash-container", partial: "shared/flash_messages", locals: { flash: flash } %>

<%# メンバーセクション全体を置き換える（表示モードに戻す） %>
<%= turbo_stream.replace "members-section" do %>
  <%# 参加者 - しおりの有無に関わらず常に表示 %>
  <div class="mb-6 lg:mb-8" id="members-section" data-controller="member-delete">
    <%# 通常表示モード %>
    <div id="members-display" data-member-delete-target="display">
      <div class="mb-4 lg:mb-6 cursor-pointer">
        <div id="members-count" class="flex items-center gap-3 lg:gap-6 mb-2 lg:mb-3">
          <label for="members-textarea-content" class="block text-sm lg:text-base font-medium text-text">
            <%= t('groups.show.members') %>（<%= @group.group_memberships.count.to_s %>名）
          </label>
          <button
            data-controller="clipboard"
            data-clipboard-text-value="<%= new_membership_url(@group.invite_token) %>"
            data-action="click->clipboard#copy"
            title="<%= t('groups.show.invite_button') %>"
            class="btn-main w-auto p-2 lg:px-4 lg:py-2 flex items-center gap-2 lg:gap-3 text-sm lg:text-base shrink-0">
            <div class="flex items-center justify-center">
              <%= render IconComponent.new(name: "add_membership_icon", size: 6, breakpoints: { lg: 8 }, color: "text-text-light") %>
            </div>
            <span class="hidden lg:inline"><%= t('groups.show.invite_button') %></span>
          </button>
        </div>
        <%= text_area_tag :member, @group.group_memberships.map(&:group_nickname).join("\n"), id: "members-textarea-content", readonly: true, class: "form-text-field bg-gray-100 resize-none min-h-[90px] cursor-pointer text-sm lg:text-base", data: { action: "click->member-delete#toggleDelete" } %>
      </div>
    </div>

    <%# 削除モード（非表示） %>
    <div id="members-delete-mode" data-member-delete-target="deleteMode" class="hidden">
      <h3 class="block text-xs lg:text-sm font-medium text-text mb-2 lg:mb-3"><%= t('groups.details.delete_member_title') %></h3>
      <div id="members-list" class="space-y-2 mb-4 lg:mb-6 max-h-[200px] overflow-y-auto border border-gray-300 rounded p-2 bg-white">
        <% @group.group_memberships.each do |membership| %>
          <div class="flex items-center justify-between p-2 hover:bg-gray-50 rounded">
            <span class="text-sm lg:text-base text-text"><%= membership.group_nickname %></span>
            <%# オーナーのみが削除ボタンを表示、かつオーナー本人は削除できない %>
            <% if current_user&.id == @group.created_by_user_id && !membership.owner? %>
              <%= button_to group_group_membership_path(@group, membership), method: :delete, form_class: "inline", class: "btn-danger px-3 py-1 text-xs lg:text-sm", data: { turbo_confirm: "#{membership.group_nickname}を削除しますか？" } do %>
                削除
              <% end %>
            <% end %>
          </div>
        <% end %>
      </div>
      <div class="flex justify-end gap-2">
        <%= link_to t('groups.form.cancel'), "#", class: "btn-sub px-4 lg:px-6 py-2 w-auto text-sm lg:text-base", data: { action: "click->member-delete#cancelDelete" } %>
      </div>
    </div>
  </div>
<% end %>
