<% if @schedule.present? %>
  <%# スケジュール詳細セクション（表示/編集を切り替え） %>
  <div id="schedule-details-section" data-controller="memo-edit" class="w-full">
    <%# 表示モード %>
    <div id="schedule-details-display" data-memo-edit-target="display" class="<%= 'hidden' if @schedule.errors.any? %>">
      <%= form_with model: @schedule, class: "w-full" do |f| %>
        <div class="flex gap-6">
          <%# 開始日 %>
          <div class="mb-6 cursor-pointer">
            <%= f.label :start_date, t('groups.form.start_date'), class: "block text-sm font-medium text-text mb-2" %>
            <%= f.date_field :start_date, readonly: true, class: "form-text-field bg-gray-100 cursor-pointer", data: { action: "click->memo-edit#toggleForm" } %>
          </div>
          <%# 終了日 %>
          <div class="mb-6 cursor-pointer">
            <%= f.label :end_date, t('groups.form.end_date'), class: "block text-sm font-medium text-text mb-2" %>
            <%= f.date_field :end_date, readonly: true, class: "form-text-field bg-gray-100 cursor-pointer", data: { action: "click->memo-edit#toggleForm" } %>
          </div>
        </div>
      <% end %>
    </div>

    <%# 編集モード（非表示） %>
    <div id="schedule-details-form" data-memo-edit-target="form" class="<%= 'hidden' unless @schedule.errors.any? %>">
      <%= form_with model: [@group, @schedule], local: true do |f| %>
        <%= f.hidden_field :from_page, value: "show" %>
        <div class="flex gap-6">
          <%# 開始日 %>
          <div class="flex-1">
            <%= f.label :start_date, t('groups.form.start_date'), class: "block text-sm font-medium text-text mb-2" %>
            <%= f.date_field :start_date, class: "form-text-field w-full" %>
          </div>
          <%# 終了日 %>
          <div class="flex-1">
            <%= f.label :end_date, t('groups.form.end_date'), class: "block text-sm font-medium text-text mb-2" %>
            <%= f.date_field :end_date, class: "form-text-field w-full" %>
          </div>
        </div>
        <%# エラーメッセージ表示 %>
        <% if @schedule.errors.any? %>
          <div class="">
            <% @schedule.errors.messages[:start_date]&.each do |message| %>
              <p class="text-red-600 text-xs"><%= t('activerecord.attributes.schedule.start_date') %><%= message %></p>
            <% end %>
            <% @schedule.errors.messages[:end_date]&.each do |message| %>
              <p class="text-red-600 text-xs"><%= t('activerecord.attributes.schedule.end_date') %><%= message %></p>
            <% end %>
          </div>
        <% end %>
        <%# ボタン %>
        <div class="flex gap-2 mt-2 justify-end">
          <%= f.submit t('groups.form.update'), class: "btn-main px-4 py-2 w-auto" %>
          <button type="button" class="btn-sub px-4 py-2 w-auto" data-action="click->memo-edit#toggleForm">
            ×
          </button>
        </div>
      <% end %>
    </div>
  </div>
<% end %>

<%# 参加者 - しおりの有無に関わらず常に表示 %>
<div class="mb-6" id="members-section" data-controller="member-delete">
  <%# 通常表示モード %>
  <div id="members-display" data-member-delete-target="display">
    <div class="mb-6 cursor-pointer">
      <div id="members-count" class="flex items-center justify-between mb-2">
        <label for="members-textarea-content" class="block text-sm font-medium text-text">
          <%= t('groups.show.members') %>（<%= @group.group_memberships.count.to_s %>名）
        </label>
        <button
          data-controller="clipboard"
          data-clipboard-text-value="<%= new_membership_url(@group.invite_token) %>"
          data-action="click->clipboard#copy"
          title="<%= t('groups.show.invite_button') %>"
          class="btn-main w-auto px-4 py-2 text-sm shrink-0">
          <%= t('groups.show.invite_member_button') %>
        </button>
      </div>
      <%= text_area_tag :member, @group.group_memberships.map(&:group_nickname).join("\n"), id: "members-textarea-content", readonly: true, class: "form-text-field bg-gray-100 resize-none min-h-[90px] cursor-pointer", data: { action: "click->member-delete#toggleDelete" } %>
    </div>
  </div>

  <%# 削除モード（非表示） %>
  <div id="members-delete-mode" data-member-delete-target="deleteMode" class="hidden">
    <h3 class="block text-xs font-medium text-text mb-2"><%= t('groups.details.delete_member_title') %></h3>
    <div id="members-list" class="space-y-2 mb-4 max-h-[200px] overflow-y-auto border border-gray-300 rounded p-2 bg-white">
      <% @group.group_memberships.each do |membership| %>
        <div class="flex items-center justify-between p-2 hover:bg-gray-50 rounded">
          <span class="text-sm text-text"><%= membership.group_nickname %></span>
          <%# オーナーのみが削除ボタンを表示、かつオーナー本人は削除できない %>
          <% if current_user&.id == @group.created_by_user_id && !membership.owner? %>
            <%= button_to group_group_membership_path(@group, membership), method: :delete, form_class: "inline", class: "btn-danger px-3 py-1 text-sm", data: { turbo_confirm: "#{membership.group_nickname}#{t('groups.details.delete_confirm')}" } do %>
              <%= t('groups.details.delete_button') %>
            <% end %>
          <% end %>
        </div>
      <% end %>
    </div>
    <div class="flex justify-end gap-2">
      <%= link_to t('groups.form.cancel'), "#", class: "btn-sub px-4 py-2 w-auto", data: { action: "click->member-delete#cancelDelete" } %>
    </div>
  </div>
</div>
