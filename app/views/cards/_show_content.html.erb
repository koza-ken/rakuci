<% content_for(:title, @card.name) %>
<% breadcrumb :card, @card %>

<%= turbo_frame_tag "spot-create-modal", data: { controller: "modal" } %>
<%= turbo_frame_tag "add_new_schedule_spot" %>

<div class="relative z-20 w-full max-w-2xl max-h-screen overflow-y-auto bg-main-bg rounded-md">
  <main class="flex flex-col px-8 py-6 bg-main-bg">

    <%# カード名セクション（表示/編集を切り替え） %>
    <div id="card-name-section" data-controller="card-edit">
      <%# 表示モード %>
      <div id="card-name-display" class="flex items-start gap-6 mb-4" data-card-edit-target="display">
        <h1 class="text-2xl font-bold text-text"><%= @card.name %></h1>
        <%# 編集アイコン（サイズ固定） %>
        <button class="shrink-0 text-text hover:opacity-70 transition pt-1" data-action="click->card-edit#toggleForm">
          <%= render "shared/icon/form_icon_edit" %>
        </button>
      </div>

      <%# 編集モード（非表示） %>
      <div id="card-name-form" class="hidden mb-4" data-card-edit-target="form">
        <%= form_with model: @card, local: true do |f| %>
          <div class="flex items-center gap-2">
            <%= f.text_field :name, class: "form-text-field flex-1" %>
            <%= f.submit t('cards.form.update'), class: "btn-main px-4 py-2 w-auto" %>
            <button type="button" class="btn-sub w-auto px-2 py-1" data-action="click->card-edit#toggleForm">
              <p class="text-2xl">×</p>
            </button>
          </div>
        <% end %>
      </div>
    </div>

    <%# スポット追加ボタン %>
    <div class="flex justify-end mb-2 w-auto" data-controller="modal">
      <%= link_to (@card.group_card? ? new_group_card_spot_path(@card.group, @card) : new_card_spot_path(@card)), data: {turbo_frame: "spot-create-modal", action: "click->modal#setGroupId"}, class: "btn-main px-4 py-2 w-auto" do %>
        <%= t('cards.add_spot') %>
      <% end %>
    </div>
    <div class="mb-4">
      <% if !@card.group_card? %>
        <%# 個人カード: チェックボックスフォーム %>
        <%= form_with url: card_new_schedule_spots_path(@card), method: :get, data: { turbo_frame: "add_new_schedule_spot" } do |f| %>
          <%= render "spots/spots", spots: @card.spots, categories: @categories %>
          <div class="flex gap-2 mt-4">
            <%= f.submit t('cards.add_spots_to_schedule'), class: "btn-main flex-1" %>
          </div>
        <% end %>
      <% else %>
        <%# グループカード: チェックボックスフォーム %>
        <%= form_with url: group_card_schedule_spots_path(@card.group, @card), method: :post, local: true do |f| %>
          <%= render "spots/spots", spots: @card.spots, categories: @categories %>
          <div class="flex gap-2 mt-4">
            <%= f.submit t('cards.add_spots_to_schedule'), class: "btn-main flex-1" %>
          </div>
        <% end %>
      <% end %>
    </div>

    <%# コメント欄（グループカードのみ） %>
    <% if @card.group_card? %>
      <div class="mb-6">
        <h2 class="text-xl font-bold text-text-light mb-4"><%= t('cards.comments') %></h2>
        <%# コメント一覧 %>
        <div id="comments_list">
          <% if @comments.present? %>
            <div class="space-y-3 mb-4">
              <% @comments.each do |comment| %>
                <%= render "comments/comment", comment: comment %>
              <% end %>
            </div>
          <% else %>
            <p class="text-gray-500 text-sm mb-4"><%= t('cards.no_comments') %></p>
          <% end %>
        </div>
        <%# 新規コメント投稿フォーム %>
        <div id="comment_form">
          <%= render "comments/form", card: @card, comment: Comment.new %>
        </div>
      </div>
    <% end %>

    <%# メモセクション（表示/編集を切り替え） %>
    <div id="memo-section" class="w-full max-w-md" data-controller="memo-edit">
      <%# 表示モード %>
      <div id="memo-display" data-memo-edit-target="display">
        <%= form_with model: @card, class: "w-full" do |f| %>
          <%= f.label :memo, t('cards.form.memo'), class: "block text-2xl font-bold text-text mb-2" %>
          <%= f.text_area :memo, class: "form-text-field bg-gray-100 cursor-pointer", readonly: true, data: { action: "click->memo-edit#toggleForm" } %>
        <% end %>
      </div>

      <%# 編集モード（非表示） %>
      <div id="memo-form" data-memo-edit-target="form" class="hidden">
        <%= form_with model: @card, local: true, class: "w-full" do |f| %>
          <%= f.label :memo, t('cards.form.memo'), class: "block text-2xl font-bold text-text mb-2" %>
          <%= f.text_area :memo, class: "form-text-field flex-1 resize-none min-h-[100px]", placeholder: t('cards.memo_input_placeholder') %>
          <div class="flex gap-2 mt-2">
            <%= f.submit t('cards.form.update'), class: "btn-main px-4 py-2 w-auto" %>
            <button type="button" class="btn-sub px-4 py-2 w-auto" data-action="click->memo-edit#toggleForm">
              <%= t('cards.form.cancel') %>
            </button>
          </div>
          <%# エラーメッセージ表示 %>
          <% if @card.errors.any? %>
            <div class="mt-2">
              <% @card.errors.messages[:memo].each do |message| %>
                <p class="text-red-600 text-sm"><%= message %></p>
              <% end %>
            </div>
          <% end %>
        <% end %>
      </div>
    </div>

    <%# 戻るボタンと削除ボタン %>
    <div class="mt-8">
      <% if @card.group_card? %>
        <%= link_to group_path(@card.group), class: "btn-sub block text-center" do %>
          <%= t("cards.form.back") %>
        <% end %>
      <% else %>
        <%= link_to cards_path, class: "btn-sub block text-center" do %>
          <%= t("cards.form.back") %>
        <% end %>
      <% end %>
    </div>
    <div class="flex justify-center mt-18">
      <%= button_to (@card.group_card? ? group_card_path(@card.group, @card) : card_path(@card)), method: :delete, data: { turbo_confirm: t("cards.delete_confirm") }, class: "btn-danger" do %>
        <%= t("cards.delete_button") %>
      <% end %>
    </div>
  </main>
</div>
